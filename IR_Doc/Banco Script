--  QUERO CADASTRAR UMA NOVA COMPRA DE 100 BPAN4 A 8 REAIS, PARA ISSO, VERIFICA-SE A TABELA DA CARTEIRA DO USUÁRIO VARA AVERIGUAR COMO ESTA O SALDO DO BPAN4, POSSIVEIS CASOS:
--  CASO 1 - SALDO ESTÁ NULO OU ZERADO.
		   -- NA TABELA MOVIMENTAÇÃO: CRIASSE UMA NOVA MOVIMENTAÇÃO COM OS DADOS DE DATA,QTD,VALOR,ETC.
		   -- NA TABELA CARTEIRA: ALTERA OU CRIA UM ITEM COM OS DADOS DE NOME E SALDO PASSA PARA 100 E MÉDIA PARA 8.
		   
-- CASO 2 - USUÁRIO JÁ HAVIA COMPRADO 100 BPAN4 A 9 REAIS. 
		   -- NA TABELA MOVIMENTAÇÃO: SOMA NOVA COMPRA COM SALDO QUE JA TINHA(100+100)
									 -- PREÇO MÉDIO NOVO = ((SALDO ANTIGO(100) VEZES PREÇO MÉDIO ANTIGO(9))MAIS(SALDO NOVO(100) VEZES PREÇO POR UNIDADE(8)) DIVIDIDO PELO SALDO ATUALIZADO(200).
									 -- ATUALIZA A DATA PARA O DIA DA ÚLTIMA COMPRA.
		   -- NA TABELA CARTEIRA: SOMA NOVA COMPRA COM SALDO QUE JA TINHA(100+100)
							   -- PREÇO MÉDIO NOVO = ((SALDO ANTIGO(100) VEZES PREÇO MÉDIO ANTIGO(9))+(SALDO NOVO(100) VEZES PREÇO POR UNIDADE(8)) DIVIDIDO PELO SALDO ATUALIZADO(200).  
							   
-- CASO 3 - SALDO ESTA COM VALOR -100 BPAN4 A 9 REAIS.
		   -- NA TABELA MOVIMENTAÇÃO: FILTRA AS MOVIMENTAÇÕES PELO CODIGO DO BPAN4 EM BUSCA DA MOVIMENTAÇÃO QUE ESTA SEM COMPRA, MODIFICA ELA INSERINDO OS DADOS DESSA COMPRA.
		   -- NA TABELA CARTEIRA: ZERA O SALDO E MÉDIA.
		   
-- CASO 4 - SALDO ESTA COM VALOR -500 BPAN4 A 9 REAIS.
		   -- NA TABELA MOVIMENTAÇÃO: CRIA OUTRA MOVIMENTAÇÃO COM MESMA DATA E PREÇO MÉDIO(9) DA VENDA EXISTENTE. MAS A NOVA TERÁ QTD=-100 E A ANTIGA PASSA A TER SÓ -400. NA NOVA ADICIONA OS DADOS DA COMPRA.
		   -- NA TABELA CARTEIRA: ATUALIZA SALDO PARA -400, PREÇO MÉDIO MANTEM.

		   
-- QUERO CADASTRAR UMA NOVA VENDA DE 100 (NO CASO, PARA O USUÁRIO É VENDA DE 100, PARA O SISTEMA É -100 PARA OS SALDOS) BPAN4 A 8 REAIS, PARA ISSO, VERIFICA-SE A TABELA DA CARTEIRA DO USUÁRIO VARA AVERIGUAR COMO ESTA O SALDO DO BPAN4, POSSIVEIS CASOS:
-- CASO 1 - SALDO ESTÁ NULO OU ZERADO.
		   -- NA TABELA MOVIMENTAÇÃO: CRIASSE UMA NOVA MOVIMENTAÇÃO COM OS DADOS DE DATA,QTD,VALOR,ETC.
		   -- NA TABELA CARTEIRA: ALTERA OU CRIA UM ITEM COM OS DADOS DE NOME E SALDO PASSA PARA -100 E MÉDIA PARA 8.
		   
-- CASO 2 - USUÁRIO JÁ HAVIA VENDIDO 100 BPAN4 A 9 REAIS. 
		  -- NA TABELA MOVIMENTAÇÃO: JUNTA A NOVA VENDA COM A QUE JA TINHA(-100-100)
									 -- PREÇO MÉDIO NOVO = ((SALDO ANTIGO(100)(*CUIDAR COM SINAIS*) VEZES PREÇO MÉDIO ANTIGO(9))MAIS(SALDO NOVO(100)(*CUIDAR COM SINAIS*) VEZES PREÇO POR UNIDADE(8)) DIVIDIDO PELO SALDO ATUALIZADO(200).
									 -- ATUALIZA A DATA PARA O DIA DA ÚLTIMA DA ÚLTIMA VENDA.
		   -- NA TABELA CARTEIRA: SUBTRAI NOVA VENDA DO SALDO QUE JA TINHA(-100-100)
							   -- PREÇO MÉDIO NOVO = ((SALDO ANTIGO(100) VEZES PREÇO MÉDIO ANTIGO(9))+(SALDO NOVO(100) VEZES PREÇO POR UNIDADE(8)) DIVIDIDO PELO SALDO ATUALIZADO(200). 
							   
-- CASO 3 - SALDO ESTA COM VALOR +100 BPAN4 A 9 REAIS.
		   -- NA TABELA MOVIMENTAÇÃO: FILTRA AS MOVIMENTAÇÕES PELO CODIGO DO BPAN4 EM BUSCA DA MOVIMENTAÇÃO QUE ESTA SEM VENDA, MODIFICA ELA INSERINDO OS DADOS DESSA VENDA.
		   -- NA TABELA CARTEIRA: ZERA O SALDO E MÉDIA.
		   
-- CASO 4 - SALDO ESTA COM VALOR +500 BPAN4 A 9 REAIS.
		   -- NA TABELA MOVIMENTAÇÃO: CRIA OUTRA MOVIMENTAÇÃO COM MESMA DATA E PREÇO MÉDIO(9) DA VENDA EXISTENTE. MAS A NOVA TERÁ QTD=100 E A ANTIGA PASSA A TER SÓ 400. NA NOVA ADICIONA OS DADOS DA VENDA.
		   -- NA TABELA CARTEIRA: ATUALIZA SALDO PARA 400, PREÇO MÉDIO MANTEM.

CREATE TABLE ATIVO (
 CD_ATIVO INT (5) NOT NULL,
 NM_CODATIVO VARCHAR (10) NOT NULL,
 DS_DESCRCAO VARCHAR (50) NOT NULL,
 D_E_L_E_T VARCHAR (1) NOT NULL
 );
		   
CREATE TABLE USUARIOS (
 CD_USUARIO INT (6) NOT NULL,
 NM_USUARIO VARCHAR (30) NOT NULL,
 NM_EMAIL VARCHAR (70) NOT NULL,
 NR_TELEFONE INT (14) NOT NULL,
 DT_NASC DATE NOT NULL,
 DS_GENERO INT (1) NOT NULL,
 NM_LOGIN VARCHAR (30) NOT NULL,
 DS_SENHA VARCHAR (20) NOT NULL,
 NR_CPF INT (10) NOT NULL,
 D_E_L_E_T VARCHAR (1) NOT NULL
 );
 
 
CREATE TABLE CARTEIRA (
 CD_CARTEIRA INT (5) NOT NULL,
 CD_ATIVO INT (5) NOT NULL,
 CD_USUARIO INT (5) NOT NULL,
 NR_QTDSALDO INT NOT NULL,
 NR_PRECOMEDIO FLOAT (40,15) NOT NULL,
 D_E_L_E_T VARCHAR (1) NOT NULL
 );

CREATE TABLE MOVIMENTACAO (
 CD_MOVIMENTACAO INT (5) NOT NULL,
 CD_CARTEIRA INT (5) NOT NULL,
 CD_USUARIO INT (5) NOT NULL,
 DT_COMPRA DATE,
 NR_QTDCOMPRA INT,
 NR_VALNACP FLOAT (40,15),
 DT_VENDA DATE,
 NR_QTDVENDA INT,
 NR_VALNAVD FLOAT (40,15),
 NR_TXREG FLOAT (10,3),
 NR_EMOLUM FLOAT (10,3),
 NR_TXLIQUI FLOAT (10,3),
 NR_IRRF FLOAT (10,3),
 D_E_L_E_T VARCHAR (1) NOT NULL
 );
 
CREATE TABLE CRUDMOVI (
 CD_CRUD INT (5) NOT NULL,
 CD_MOVIMENTACAO INT (5) NOT NULL,
 NR_NVQTD INT NOT NULL,
 NR_NVVAL FLOAT (40,15) NOT NULL,
 NR_NVEMONUM FLOAT (10,3) NOT NULL,
 NR_NVTXLIQUI FLOAT (10,3) NOT NULL,
 NR_NVIRRF FLOAT (10,3) NOT NULL,
 DT_MOD DATE NOT NULL,
 D_E_L_E_T VARCHAR (1) NOT NULL
 ); 
 
CREATE TABLE RELDASH (
 CD_REL INT (5) NOT NULL,
 CD_USUARIO INT (5) NOT NULL,
 DT_REL DATE NOT NULL, 
 TP_REL INT (2) NOT NULL,
 D_E_L_E_T VARCHAR (1) NOT NULL
 );

ALTER TABLE ATIVO ADD CONSTRAINT ATIVO_PK PRIMARY KEY (CD_ATIVO); 
ALTER TABLE USUARIO ADD CONSTRAINT USUARIO_PK PRIMARY KEY (CD_USUARIO); 
ALTER TABLE CARTEIRA ADD CONSTRAINT CARTEIRA_PK PRIMARY KEY (CD_CARTEIRA,CD_ATIVO,CD_USUARIO);
ALTER TABLE MOVIMENTACAO ADD CONSTRAINT MOVIMENTACAO_PK PRIMARY KEY (CD_MOVIMENTACAO,CD_CARTEIRA,CD_USUARIO);
ALTER TABLE CRUDMOVI ADD CONSTRAINT CRUDMOVI_PK PRIMARY KEY (CD_CRUD,CD_MOVIMENTACAO);
ALTER TABLE RELDASH ADD CONSTRAINT RELDASH_PK PRIMARY KEY (CD_REL,CD_USUARIO); 

ALTER TABLE CARTEIRA ADD CONSTRAINT CAR_ATI_FK FOREIGN KEY (CD_ATIVO) REFERENCES ATIVO (CD_ATIVO);
ALTER TABLE CARTEIRA ADD CONSTRAINT CAR_USU_FK FOREIGN KEY (CD_USUARIO) REFERENCES USUARIO (CD_USUARIO);
ALTER TABLE MOVIMENTACAO ADD CONSTRAINT MOV_CAR_FK FOREIGN KEY (CD_CARTEIRA) REFERENCES CARTEIRA (CD_CARTEIRA);
ALTER TABLE MOVIMENTACAO ADD CONSTRAINT MOV_USU_FK FOREIGN KEY (CAD_USUARIO) REFERENCES USUARIO (CD_USUARIO);
ALTER TABLE CRUDMOVI ADD CONSTRAINT CRU_MOV_FK FOREIGN KEY (CD_MOVIMENTACAO) REFERENCES MOVIMENTACAO (CD_MOVIMENTACAO);
ALTER TABLE RELDASH ADD CONSTRAINT REL_USU_FK FOREIGN KEY (CD_USUARIO) REFERENCES USUARIO (CD_USUARIO);
 